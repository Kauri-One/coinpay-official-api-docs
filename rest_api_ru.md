- [Обработка запросов](#обработка-запросов)
- [Публичные данные](#публичные-данные)
  - [Получение списка активных валют](#получение-списка-активных-валют)
  - [Получение списка активных пар](#получение-списка-активных-пар)
  - [Получение цен](#получение-цен)
  - [Подсчёт стоимости обмена](#подсчёт-стоимости-обмена)
- [Пользовательские данные](#пользовательские-данные)
  - [Создание аккаунта](#создание-аккаунта)
  - [Виды аккаунтов](#виды-аккаунтов)
  - [Виды авторизации](#виды-авторизации)
    - [JWT авторизация](#jwt-авторизация)
    - [Авторизация с помощью подписи запроса](#авторизация-с-помощью-подписи-запроса)
  - [Получение баланса](#получение-баланса)
  - [Получение настроек по аккаунту](#получение-настроек-по-аккаунту)



## Обработка Запросов
* Базовый api url - https://coinpay.org.ua/
* Content-Type - json

Каждый ответ содержит структуру, в которой есть поле "status" - которое отвечает за удачно обработанный запрос, или нет. Удачно обработанный ответ имеет статус-код - 2XX, не удачно - или 4XXX, или 5XX.

###### Пример удачно обработанного запроса:

```javascript
 {"status": "success"}
```

###### Пример не удачно обработанного запроса:

```javascript
 {"status": "error", "error": <имя ошибки>}
```

Кодов ошибок нету, есть только словестно описанная причина.
По-умолчанию все ошибки возвращаються на английском языке.
Есть возможность локализировать ошибки на русский язык, добавив к самому запросу след.заголовок - "Accept-Language" со значением "ru"

# Публичные Данные
## Получение списка активных валют

```javascript
 GET "/api/v1/currency"
```
###### Пример ответа :

```javascript
{
  "status": "success",
  "currencies": ["BTC","EUR",...]
}

```
Система возвращает список валют, которые на данный момент активны и имя самой валюты, как она подписана в системе

## Получение списка активных пар
```javascript
GET "/api/v1/pair"
```

###### Пример ответа :

```javascript
{
  "status": "success",
  "pairs": [
    [
      {
        "currency_to_spend": "UAH",
        "currency_to_get": "BTC",
        "name": "BTC_UAH",
        "base_currency": "BTC"
      }
    ],
```

API ендпоинт возвращает список активных пар, по которым можно совершать обмены.

**Расшифрока названия пары:**

Обычно в обмене принимают участие две валюты, одна - которую человек тратит, другая - которую получает.
В рамках текущего примера, пара "BTC_UAH" расшифроваеться как покупка BTC за UAH.
Для покупки, UAH за BTC - нужно использовать другую пару - "UAH_BTC". По-факту, у нас - одна пара, это одно направление обмена

## Получение цен


```javascript
 GET "api/v1/exchange_rate"
```

###### Пример ответа :

```javascript
{  
  "rates": [  
    {  
      "pair": "UAH_EUR",  
      "base_currency_price": 0.03800836,  
      "price": 26.31  
    }  
  ]  
}                              
																						
```

По текущему API ендпоинту, можно получить все цены по всем парам на обмен(ticker)


## Подсчёт стоимости обмена

```javascript
 GET "api/v1/exchange/calculate"
```

###### Параметры:

```javascript
currency_to_get - обязательный. Валюта, которую пользователь получает
currency_to_spend - обязательный. Валюта, которую пользователь тратит
currency_to_get_amount, currency_to_spend_amount - нужно указать один из параметров для подсчёта, либо "размер, валюты которую нужно получить", либо "размер валюты которую пользователь хочет потратить"
exchange_price - необязательный параметр. Можно указать цену для обмена, если не указываеться цена, берёться цена по рынку.
```

###### Пример ответа:

```javascript
{
  "currency_to_get_amount": 1,
  "currency_to_get": "BTC",
  "currency_to_spend_amount": 202170.7475,
  "currency_to_spend": "UAH",
  "status": "success",
  "exchange_price": 202170.7475
}
```
При каждом просчёте в ответе всегда возращаеться подсчитанный обмен(цена обмена, сколько будет потрачено и какой валюты и сколько будет получено)

# Пользовательские данные
## Создание аккаунта

```javascript
  POST "api/v1/user/create"
```

###### Параметры:

```javascript
{
    "email": "string",
    "username": "string",
    "password": "string",
}                                                  

```

Все указанные выше поля являються обязательные к заполнение. После успешного выполнения апи запроса - нужно подтвердить емейл(письмо будет отправлено на почту), только после подтверждения емейла - можно проходить авторизацию.
В теле письма, есть ссылка на которую нужно начать чтобы подтвердить email. Время жизни ссылки - 1 день

## Виды аккаунтов
После того, как пользователь подтвердил своей емейл, его аккаунт становиться - "NOT_VERIFIED"
После прохождения верификации, аккаунт меняеться на "VERIFIED"
Есть третий вид аккаунта, как бизнес-пользователь(мерчант) - "BUSINESS"

## Виды авторизации
На данный момент времени, есть два вида авторизации по АПИ - c помощью JWT токена и с помощью подписи запроса через api_key и api_secret.
Сам пользователь уже выбирают какой авторизацией пользоваться. Мы рекомендуем пользоваться подписью запроса.

### JWT авторизация

```javascript
POST "api/v1/user/obtain_token"
```
###### Параметры:

```javascript
{
  "email": "string",
  "password": "string"
}                                              

```
###### Пример удачного ответа(полученного токена:
```javascript
{
  "username": "<username>",
  "token": "<token>"
}
```
После того, как был получен токен, можно выполнять запросы,которые требуют прохождения авторизации.
Токен нужно указывать в заголовке --header 'Authorization: Bearer <token> . Время жизни токена - 15 минут. 
В том же формате указывается токен для "Swagger"(через кнопку Authorize), чтобы он перегрузился и показал все доступные методы, которые разрешены пользователю.
	
После истечения срока жизни токена, нужно его "переполучить", через "obtain token" метод

### Авторизация с помощью подписи запроса
После прохождения верификации - будут предоставлены api_key и api_secret.
Для того, чтобы пользоваться авторизацией через подпись запроса, нужно передавать два заголовка:

```javascript
--header 'Sign: <generated_signature>' --header 'Key: <api_key>'                                          
```
###### Алгоритм создания подписи:
**Шаг 1:**  Нужно отсортировать параметры запроса в алфавитному порядке, если есть вложенность в параметрах, то её преобразовать.

**Пример без вложенности:**

```javascript
{
  "currency": "string",
  "amount": "string"
}							
```
В данном случае, должен получиться словарь, но уже с отсортированными ключами:

```javascript
{
  "amount": "string",
  "currency": "string"
}							
```

**Пример если есть вложенность:**
```javascript
{
  "currency": "string",
  "amount": "string",
  "additional_info": {"client_ip": "8.8.8.8"}
}
```

**Трансформируеться в словарь след.вида:**
{
  "currency": "string",
  "amount": "string",
  "additional_info_client_ip": "8.8.8.8"
}
Ключи полученного словаря, нужно отсортировать в альфавитном порядке.


**Шаг 2:**  Создается строка на подпись в таком формате:

```javascript
{request.method} - {request.path} - {sorted_params}
```

**Шаг 3:**  Подписывается строка api_secret, с помощью алгоритма - hmac_sha_256
Подобные манипуляции нужно проводить с каждым запросом

## Получение баланса пользователя

```javascript
  GET "api/v1/user/balance"
```
###### Пример ответа :

```javascript
{
"wallets": {
    "USDT": {
      "address": "0x85E12eA5270C8848D9258FB76de475144dBC1E3e",
      "qr_file_data": img in base64
    },
    ...
  },
  "balance": {
    "EUR": {
      "currency": "EUR",
      "EUR": {
        "reserved": 0,
        "total": 0
      },
      "ETH": {
        "reserved": 0,
        "total": 0
      },
      "UAH": {
        "reserved": 0,
        "total": 0
      },
      "USDT": {
        "reserved": 0,
        "total": 0
      },
      "USD": {
        "reserved": 0,
        "total": 0
      },
      "RUB": {
        "reserved": 0,
        "total": 0
      },
      "BTC": {
        "reserved": 0,
        "total": 0
      }
    },
    ...
  }
}                                                  

```
В балансе приходят крипто-адреса, которые можно пополнять, получается это адреса закреплены за пользователем. Также приходит сам баланс - есть два поля : "total", "reserved". "Total" - означает общее количество средств, "Reserved" - количество средств, которое уже занято, находиться в заявках. По балансу можно получить сколько есть средств на данный момент по конкретной валюте, плюс можно получить пересчёт средств одной валюты в другую.

**Например:**

1) Получение сколько есть "EUR" на аккаунте - balance[‘EUR’][‘EUR’]

2) Получение сколько есть "EUR" в "ETH" - balance[‘EUR’][‘ETH’]


## Получение настроек по аккаунту

