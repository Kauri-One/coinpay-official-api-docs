- [Обработка запросов](#обработка-запросов)
- [Публичные данные](#публичные-данные)
  - [Получение списка активных валют](#получение-списка-активных-валют)
  - [Получение списка активных пар](#получение-списка-активных-пар)
  - [Получение цен](#получение-цен)
  - [Подсчёт стоимости обмена](#подсчёт-стоимости-обмена)
- [Пользовательские данные](#пользовательские-данные)
  - [Создание аккаунта](#создание-аккаунта)
  - [Виды аккаунтов](#виды-аккаунтов)
  - [Виды авторизации](#виды-авторизации)
    - [JWT авторизация](#jwt-авторизация)
    - [Авторизация с помощью подписи запроса](#авторизация-с-помощью-подписи-запроса)
  - [Получение баланса](#получение-баланса)
  - [Получение настроек по аккаунту](#получение-настроек-по-аккаунту)
- [Заявки](#заявки)
  - [Получение деталей по заявке](#получение-деталей-по-заявке)
  - [Получение истории по заявкам](#получение-истории-по-заявкам)
  - [Заявка на депозит](#заявка-на-депозит)
    - [Схема работы депозитной заявки](#схема-работы-депозитной-заявки)
    - [Получение настроек по депозитной заявке](#получение-настроек-по-депозитной-заявке)
    - [Получение адреса для пополнения](#получение-адреса-для-пополнения)
  



## Обработка Запросов
* Базовый api url - https://coinpay.org.ua/
* Content-Type - json

Каждый ответ содержит структуру, в которой есть поле "status" - которое отвечает за удачно обработанный запрос, или нет. Удачно обработанный ответ имеет статус-код - 2XX, не удачно - или 4XXX, или 5XX.

###### Пример удачно обработанного запроса:

```javascript
 {"status": "success"}
```

###### Пример не удачно обработанного запроса:

```javascript
 {"status": "error", "error": <имя ошибки>}
```

Кодов ошибок нету, есть только словестно описанная причина.
По-умолчанию все ошибки возвращаються на английском языке.
Есть возможность локализировать ошибки на русский язык, добавив к самому запросу след.заголовок - "Accept-Language" со значением "ru"

# Публичные Данные
## Получение списка активных валют

```javascript
 GET "/api/v1/currency"
```
###### Пример ответа :

```javascript
{
  "status": "success",
  "currencies": ["BTC","EUR",...]
}

```
Система возвращает список валют, которые на данный момент активны и имя самой валюты, как она подписана в системе

## Получение списка активных пар
```javascript
GET "/api/v1/pair"
```

###### Пример ответа :

```javascript
{
  "status": "success",
  "pairs": [
    [
      {
        "currency_to_spend": "UAH",
        "currency_to_get": "BTC",
        "name": "BTC_UAH",
        "base_currency": "BTC"
      }
    ],
```

API ендпоинт возвращает список активных пар, по которым можно совершать обмены.

**Расшифрока названия пары:**

Обычно в обмене принимают участие две валюты, одна - которую человек тратит, другая - которую получает.
В рамках текущего примера, пара "BTC_UAH" расшифроваеться как покупка BTC за UAH.
Для покупки, UAH за BTC - нужно использовать другую пару - "UAH_BTC". По-факту, у нас - одна пара, это одно направление обмена

## Получение цен


```javascript
 GET "api/v1/exchange_rate"
```

###### Пример ответа :

```javascript
{  
  "rates": [  
    {  
      "pair": "UAH_EUR",  
      "base_currency_price": 0.03800836,  
      "price": 26.31  
    }  
  ]  
}                              
																						
```

По текущему API ендпоинту, можно получить все цены по всем парам на обмен(ticker)


## Подсчёт стоимости обмена

```javascript
 GET "api/v1/exchange/calculate"
```

###### Параметры:

```javascript
currency_to_get - обязательный. Валюта, которую пользователь получает
currency_to_spend - обязательный. Валюта, которую пользователь тратит
currency_to_get_amount, currency_to_spend_amount - нужно указать один из параметров для подсчёта, либо "размер, валюты которую нужно получить", либо "размер валюты которую пользователь хочет потратить"
exchange_price - необязательный параметр. Можно указать цену для обмена, если не указываеться цена, берёться цена по рынку.
```

###### Пример ответа:

```javascript
{
  "currency_to_get_amount": 1,
  "currency_to_get": "BTC",
  "currency_to_spend_amount": 202170.7475,
  "currency_to_spend": "UAH",
  "status": "success",
  "exchange_price": 202170.7475
}
```
При каждом просчёте в ответе всегда возращаеться подсчитанный обмен(цена обмена, сколько будет потрачено и какой валюты и сколько будет получено)

# Пользовательские данные
## Создание аккаунта

```javascript
  POST "api/v1/user/create"
```

###### Параметры:

```javascript
{
    "email": "string",
    "username": "string",
    "password": "string",
}                                                  

```

Все указанные выше поля являються обязательные к заполнение. После успешного выполнения апи запроса - нужно подтвердить емейл(письмо будет отправлено на почту), только после подтверждения емейла - можно проходить авторизацию.
В теле письма, есть ссылка на которую нужно начать чтобы подтвердить email. Время жизни ссылки - 1 день

## Виды аккаунтов
После того, как пользователь подтвердил своей емейл, его аккаунт становиться - "NOT_VERIFIED"
После прохождения верификации, аккаунт меняеться на "VERIFIED"
Есть третий вид аккаунта, как бизнес-пользователь(мерчант) - "BUSINESS"

## Виды авторизации
На данный момент времени, есть два вида авторизации по АПИ - c помощью JWT токена и с помощью подписи запроса через api_key и api_secret.
Сам пользователь уже выбирают какой авторизацией пользоваться. Мы рекомендуем пользоваться подписью запроса.

### JWT авторизация

```javascript
POST "api/v1/user/obtain_token"
```
###### Параметры:

```javascript
{
  "email": "string",
  "password": "string"
}                                              

```
###### Пример удачного ответа(полученного токена:
```javascript
{
  "username": "<username>",
  "token": "<token>"
}
```
После того, как был получен токен, можно выполнять запросы,которые требуют прохождения авторизации.
Токен нужно указывать в заголовке --header 'Authorization: Bearer <token> . Время жизни токена - 15 минут. 
В том же формате указывается токен для "Swagger"(через кнопку Authorize), чтобы он перегрузился и показал все доступные методы, которые разрешены пользователю.
	
После истечения срока жизни токена, нужно его "переполучить", через "obtain token" метод

### Авторизация с помощью подписи запроса
После прохождения верификации - будут предоставлены api_key и api_secret.
Для того, чтобы пользоваться авторизацией через подпись запроса, нужно передавать два заголовка:

```javascript
--header 'Sign: <generated_signature>' --header 'Key: <api_key>'                                          
```
###### Алгоритм создания подписи:
**Шаг 1:**  Нужно отсортировать параметры запроса в алфавитному порядке, если есть вложенность в параметрах, то её преобразовать.

**Пример без вложенности:**

```javascript
{
  "currency": "string",
  "amount": "string"
}							
```
В данном случае, должен получиться словарь, но уже с отсортированными ключами:

```javascript
{
  "amount": "string",
  "currency": "string"
}							
```

**Пример если есть вложенность:**
```javascript
{
  "currency": "string",
  "amount": "string",
  "additional_info": {"client_ip": "8.8.8.8"}
}
```

**Трансформируеться в словарь след.вида:**
{
  "currency": "string",
  "amount": "string",
  "additional_info_client_ip": "8.8.8.8"
}
Ключи полученного словаря, нужно отсортировать в альфавитном порядке.


**Шаг 2:**  Создается строка на подпись в таком формате:

```javascript
{request.method} - {request.path} - {sorted_params}
```

**Шаг 3:**  Подписывается строка api_secret, с помощью алгоритма - hmac_sha_256
Подобные манипуляции нужно проводить с каждым запросом

## Получение баланса

```javascript
  GET "api/v1/user/balance"
```
###### Пример ответа :

```javascript
{
"wallets": {
    "USDT": {
      "address": "0x85E12eA5270C8848D9258FB76de475144dBC1E3e",
      "qr_file_data": img in base64
    },
    ...
  },
  "balance": {
    "EUR": {
      "currency": "EUR",
      "EUR": {
        "reserved": 0,
        "total": 0
      },
      "ETH": {
        "reserved": 0,
        "total": 0
      },
      "UAH": {
        "reserved": 0,
        "total": 0
      },
      "USDT": {
        "reserved": 0,
        "total": 0
      },
      "USD": {
        "reserved": 0,
        "total": 0
      },
      "RUB": {
        "reserved": 0,
        "total": 0
      },
      "BTC": {
        "reserved": 0,
        "total": 0
      }
    },
    ...
  }
}                                                  

```
В балансе приходят крипто-адреса, которые можно пополнять, получается это адреса закреплены за пользователем. Также приходит сам баланс - есть два поля : "total", "reserved". "Total" - означает общее количество средств, "Reserved" - количество средств, которое уже занято, находиться в заявках. По балансу можно получить сколько есть средств на данный момент по конкретной валюте, плюс можно получить пересчёт средств одной валюты в другую.

**Например:**

1) Получение сколько есть "EUR" на аккаунте - balance[‘EUR’][‘EUR’]

2) Получение сколько есть "EUR" в "ETH" - balance[‘EUR’][‘ETH’]


## Получение настроек по аккаунту
```javascript
  GET "api/v1/user/account_info"
```

```javascript
  {
  "name": "Свят",
  "email": "svyatoslavkravchenko@gmail.com",
  "account_type": "VERIFIED",
  "is_email_verified": true,
  "referral_id": "89f67887-cae6-4a6f-a393-a89079878a57",
  "created": "2019-02-05T08:13:48.952334",
  "is_2fa_enabled": false,
  //limits, fee, processing_rules
  }
```

В ответе приходит имя пользователя, его емейл, тип аккаунта, верифицирована ли почта, включена ли двух-факторная авторизация, также по каждому виду заявок приходят лимиты, фии, и т.д. По каждой заявке будет отдельно рассматриваться

# Заявки
## Получение деталей по заявке

При создании заявки через АПИ, система отдает order_id заявки, по которой можно узнать детали

```javascript
GET "api/v1/orders/detail"
```
###### Параметры:

```javascript
{
  "order_id" : $order_id
}						
```
В ответе можно будет получить детали по заявке, если заявку создавал конкретный аккаунт или аккаунт участвовал в этой заявке. Есть заявки, где участвуют несколько аккаунтов

В главе, по каждому из виду заявок, будет приводиться пример что конкретно каждая из заявок возвращает.

## Получение истории по заявкам

```javascript
GET "api/v1/orders/history"
```
###### Пример ответа:

```javascript
{
  "orders": [<orders_details_list>]
  "status": "success",
  "pages_count": 78
}
```
Для истории заявок присуствует постраничный вывод, на одной странице выводиться по 10 заявок.

###### Фильтра:
 - order_type - означает тип заявки. Возможные значения - `'DEPOSIT’, ‘WITHDRAWAL’, ‘EXCHANGE’, ‘INTERNAL_MOVEMENT’, ‘INVOICE'` 
 
 - order_status - означает статус заявки. Возможные значения - `‘NEW’, ‘ERROR’, ‘CLOSED’, ‘EXPIRED’, ‘CANCELLED’, ‘CANCELLING’, ‘WAITING_FOR_OPERATOR_CONFIRMATION’, ‘CONFIRMED_BY_OPERATOR’, ‘CANCELLED_BY_OPERATOR’, ‘WAITING_FOR_CONFIRMATION’, ‘WAITING_FOR_PRICE’, ‘PAYMENT_IN_PROGRESS’`

- order_sub_type - означает под-тип заявки. У некоторых заявок есть свой под-тип, по которому можно сделать фильтр
- page - указание страницы для вывода
- from_timestamp, till_timestamp - фильтрация по времени создания заявок
- currency - фильтрация по валюте.Отображает все заявки в которых принимала участие та или иная валюта
- address - находит все заявки в которых фигурировал адрес. Это может быть заявки на пополнения или вывод

## Заявка на депозит
### Схема работы депозитной заявки

Для того, чтобы пополнить аккаунт, нужно изначально получить аддрес для пополнения, после этого перевести деньги на этот счёт, это может быть как крипто-валютный адрес, так ссылка для оплаты картой. После успешного пополнения - будет создана депозитная заявка, получаеться заявка создаеться "пост-фактом".

#### Пример переходов статусов по крипто-валютам(UAH):
Успешное пополнение(зачисление денег) - "NEW->WAITING_FOR_CONFIRMATION->CLOSED"

Как только есть транзакция в сети, заявка переходит в статус "NEW", а потом в статус "WAITING_FOR_CONFIRMATION", и находиться в этом статусе до тех пор пока не будет достигнуто определённого количества подтверждений для зачисления денег на баланс. Заявка может перейти в статус "EXPIRED", если в течении суток не было достугниуто нужного количества подтверждений по транзакции

#### Пример переходов статусов по фиатным валютам(UAH):
Успешное пополнение(зачисление денег) - "NEW->CLOSED" 

Пополнение не удалось - "NEW->ERROR" 

Ссылка перестала быть активной "NEW>EXPIRED(CANCELLED)"

### Получение настроек по депозитной заявке

```git
GET "api/v1/user/account_info"
```

Есть три вида настроек - "fees", "limits", "processing_rules"

#### Лимиты

```javascript
"deposit_order_limits": {
    "UAH": {
      "GATEWAY": {
        "P2P": {
          "max_amount": 14000,
          "min_amount": 10
        }
      }
    }
  }
 ``` 
На данный момент есть лимиты на пополнения есть только для фиатных валют, указываеться лимит за операцию. В данном примере показываються лимит на пополнение "UAH", по типу пополнения - "P2P".


#### Fee

```javascript
"deposit_order_fees": {
	"BTC": {
          "GATEWAY": {
            "P2P": {
             "payment_provider_static_fee": null,
             "static_fee": 0,
             "percent_fee": null
        }
      }
    },
}													
```
Показывает какие есть фии по конкретной валюте на пополнение.

    static_fee - показывает статическое значение, которое берёться в рамках депозита
    percent_fee - показывает значение, которое берёться в рамках депозита в процентном соотношении
    payment_provider_static_fee - стоимость работы провайдера на пополнение, обычно указываеться с каким-то значением(static_fee, или percent_fee)
    
#### Processing rules

```javascript
"deposit_order_processing_rules": {
	"BTC": {
          "GATEWAY": {
            "P2P": {
              "is_deposit_enabled": true,
              "confirmations_count": 2
        }
      }
    },
}													
```
Показывает, включен ли депозит, возможно ли повторения депозита, включена ли отмена депозита. "confirmations_count" - для фиатных валют не имеет значения, для крипто-валюты показывает по скольким подтверждениям идет зачисления депозита.

### Получение адреса для пополнения

```javascript
POST "api/v1/deposit/address"
```

###### Параметры:

```javascript
{
  "amount_to_spend": "string",
  "callback_url": "string",
  "payment_type": "string",
  "currency": "string",
  "amount_to_receive": "string",
  "additional_info": {},
  "comment": "string"
}
```
**Описание параметров:**

 1. `currency - валюта, должна быть указана(обязательный параметр)`
 2. `callback_url - url для нотификации при создании депозитной заявки(не обязательный параметр)`
 3. `amount_to_spend, amount_to_receive - нужно указать один из этих параметров. В первом случае, система создаст ссылку на пополнение с учетом того сколько клиент может потратить, а во втором случае баланс будет пополнен на это значение(amount_to_receive). Нужно указывать эти поля только для пополнения фиатных валют`
 4. `comment - комментарий, которы будет указываться при создании заявки по конкретному адресу, в колл-беке будет приходить - (не обязательный параметр)`
 6. `payment_type - способ пополнения, если не указываеться берёться по-умолчанию P2P`
 7. `additional_info - словарь, с доп.параметрами. customer_id - не обязательный параметр, client_ip - обязательный параметр, deposit_email или deposit_phone нужно указывать если у вас статус аккаунта - "BUSINESS"`


###### Пример получение депозитного адреса для крипто-валюты:

```javascript
{
  "currency": "BTC",
  "callback_url": "http://",
  "additional_info": {"client_ip": "1.1.1.1",
	              "customer_id": "<some_id>"}
}
```

###### Пример получения депозитного адреса для UAH:

```javascript
{
  "amount_to_spend": "10", 
  "callback_url": "http://",
  "currency": "UAH",
  "additional_info": {
	"client_ip": "62.80.170.214",
	"deposit_email": "<some_email>"
    }
}
```

###### Анализ ответа :

```javascript
{
   "qr": "base64 img",
   "addr": "адрес для пополнения или ссылка",
   "status": "success"
}
```

"qr" будет заполнен только для крипто-валюты
